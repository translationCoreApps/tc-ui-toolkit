'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isWordArrayMatch = isWordArrayMatch;
exports.isWordMatch = isWordMatch;
exports.getWordHighlightedDetails = getWordHighlightedDetails;
exports.getWordsFromNestedMilestone = getWordsFromNestedMilestone;
exports.getDeepNestedWords = getDeepNestedWords;
exports.isPunctuationHighlighted = isPunctuationHighlighted;
exports.addSpace = addSpace;

var _react = _interopRequireDefault(require("react"));

var _isEqual = _interopRequireDefault(require("lodash/isEqual"));

var _stringHelpers = require("./stringHelpers");

var _usfmHelpers = require("./usfmHelpers");

function isWordArrayMatch(word, contextId) {
  var isMatch = false;

  if (word && word.content && Array.isArray(word.content) && contextId && contextId.quote) {
    isMatch = word.content.some(function (wordItem) {
      var foundMatch = false;

      if (Array.isArray(contextId.quote)) {
        for (var i = 0, l = contextId.quote.length; i < l; i++) {
          var quote = contextId.quote[i];

          if (quote.word === wordItem.content && quote.occurrence === wordItem.occurrence) {
            foundMatch = true;
            break;
          }
        }
      } else if (contextId.quote.split(' ').includes(wordItem.content)) {
        var stringOccurrence = contextId.occurrence;

        if (typeof stringOccurrence === 'string' && stringOccurrence.length === 0) {
          stringOccurrence = 1;
        }

        foundMatch = stringOccurrence === wordItem.occurrence;
      }

      return foundMatch;
    });
  }

  return isMatch;
}
/**
 * search word list to find occurrence of word
 * @param {number} index - position of word
 * @param {Array} words - list of word objects to search
 * @param {String} wordText - text to match
 * @param {number} occurrence - to match
 * @return {Boolean} - true if same occurrence
 */


function getOccurrenceOfWord(index, words, wordText, occurrence) {
  // get occurrence of word
  var _occurrence = 0;

  for (var i = 0; i <= index; i++) {
    var wordItem = words[i];

    if (wordItem.type === 'word' && wordItem.text === wordText) {
      _occurrence++;
    }
  }

  var isMatch = _occurrence === occurrence;
  return isMatch;
}
/**
 * see if this word is part of quote for current context id.
 * @param {Object} word
 * @param {Object} contextId
 * @param {Array} words
 * @param {number} index
 * @return {boolean} - true if in quote
 */


function isWordMatch(word, contextId, words, index) {
  var isMatch = false;

  try {
    if (word && word.text && contextId && contextId.quote) {
      if (Array.isArray(contextId.quote)) {
        // if list of words in quote see if this word matches one of the words
        for (var i = 0, l = contextId.quote.length; i < l; i++) {
          var quote = contextId.quote[i];

          if (quote.word === word.text) {
            isMatch = getOccurrenceOfWord(index, words, word.text, quote.occurrence);

            if (isMatch) {
              break;
            }
          } else if (word.text && word.text.includes('’') && word.text.replace('’', '') === quote.word) {
            var wordText = word.text.replace('’', ''); // Deep cloning array to avoid referencing the old array address in memory

            var newWords = JSON.parse(JSON.stringify(words)); // remove apostrophe from each word in the words array

            var wordsWithoutApostrophe = [];

            for (var _i = 0; _i <= index; _i++) {
              var wordItem = newWords[_i];

              if (wordItem.text && wordItem.text.includes('’')) {
                wordItem.text = wordItem.text.replace('’', '');
              }

              wordsWithoutApostrophe.push(wordItem);
            }

            isMatch = getOccurrenceOfWord(index, wordsWithoutApostrophe, wordText, quote.occurrence);

            if (isMatch) {
              break;
            }
          }
        }
      } else {
        // is string with one or more words
        var quotes = contextId.quote.split(' ');

        for (var _i2 = 0, _l = quotes.length; _i2 < _l; _i2++) {
          var _quote = quotes[_i2];

          if (_quote === word.text) {
            isMatch = getOccurrenceOfWord(index, words, _quote, contextId.occurrence);
          }
        }
      }
    }

    return isMatch;
  } catch (e) {
    console.error(e);
  }
}

function getWordHighlightedDetails(contextId, previousWord, word) {
  var isHighlightedWord = isWordArrayMatch(word, contextId);
  var isBetweenHighlightedWord = isHighlightedWord && previousWord && !(0, _isEqual["default"])(previousWord, word) && isWordArrayMatch(previousWord, contextId);
  return {
    isHighlightedWord: isHighlightedWord,
    isBetweenHighlightedWord: isBetweenHighlightedWord
  };
}

function getWordsFromNestedMilestone(nestedWords, contextId, index, previousWord, wordSpacing) {
  // if its an array of an array thus get deep nested words array.
  if (Array.isArray(nestedWords[0])) {
    nestedWords = getDeepNestedWords(nestedWords);
  }

  var isHighlightedWord = false;
  var isBetweenHighlightedWord = false;
  var nestedPreviousWord = previousWord;
  var nestedWordSpacing = wordSpacing;
  var wordSpans = [];

  for (var i = 0, len = nestedWords.length; i < len; i++) {
    var nestedWord = nestedWords[i];
    var nestedWordIndex = i;
    var wordsArray = nestedWords;
    var nestedWordSpanIndex = "".concat(index.toString(), "_").concat(nestedWordIndex.toString(), "_").concat(nestedWord.text);
    var nestedNextWord = wordsArray[index + 1];

    if ((0, _stringHelpers.isWord)(nestedWord)) {
      var padding = nestedWordSpacing;
      nestedWordSpacing = ' '; // spacing between words

      if (nestedPreviousWord && isPuntuationAndNeedsNoSpace(nestedPreviousWord)) {
        padding = '';
      }

      var highlightedDetails = getWordHighlightedDetails(contextId, nestedPreviousWord, nestedWord);
      isHighlightedWord = highlightedDetails.isHighlightedWord;
      isBetweenHighlightedWord = highlightedDetails.isBetweenHighlightedWord;
      nestedPreviousWord = nestedWord;
      var paddingSpanStyle = {
        backgroundColor: isBetweenHighlightedWord ? 'var(--highlight-color)' : 'transparent'
      };
      wordSpans.push(_react["default"].createElement("span", {
        key: nestedWordSpanIndex.toString()
      }, _react["default"].createElement("span", {
        style: paddingSpanStyle
      }, padding), _react["default"].createElement("span", {
        style: {
          backgroundColor: isHighlightedWord ? 'var(--highlight-color)' : ''
        }
      }, (0, _usfmHelpers.removeMarker)(nestedWord.text))));
    } else if (nestedWord.text) {
      nestedWordSpacing = (0, _stringHelpers.punctuationWordSpacing)(nestedWord); // spacing before words

      var text = (0, _usfmHelpers.removeMarker)(nestedWord.text);

      if (isPunctuationHighlighted(nestedPreviousWord, nestedNextWord, contextId)) {
        wordSpans.push(_react["default"].createElement("span", {
          key: nestedWordSpanIndex,
          style: {
            backgroundColor: 'var(--highlight-color)'
          }
        }, text));
      } else {
        wordSpans.push(_react["default"].createElement("span", {
          key: nestedWordSpanIndex
        }, text));
      }
    }
  }

  return {
    wordSpans: wordSpans,
    nestedPreviousWord: nestedPreviousWord,
    nestedWordSpacing: nestedWordSpacing
  };
}
/**
 * Determines if the previous word is a punctuation that
 * doesnt need spacing after it.
 * @param {Object} wordObject
 */


function isPuntuationAndNeedsNoSpace(wordObject) {
  return !(0, _stringHelpers.isWord)(wordObject) && wordObject.text === '"' || wordObject.text === '\'';
}
/**
 * Gets a words object array from a deep nested milestone.
 * @param {array} nestedWords
 */


function getDeepNestedWords(nestedWords) {
  var deepNestedWords = null;

  for (var i = 0, len = nestedWords.length; i < len; i++) {
    var nestedWord = nestedWords[i];

    if (nestedWord.text) {
      deepNestedWords = nestedWords;
    } else {
      deepNestedWords = getDeepNestedWords(nestedWord);
    }
  }

  return deepNestedWords;
}
/**
 * Determines if a punctuation should be highlighted or not.
 * @param {object} previousWord
 * @param {object} nextWord
 * @param {object} contextId
 * @returns {bool} true or false. highlighted or not highlighted.
 */


function isPunctuationHighlighted(previousWord, nextWord, contextId, words, index) {
  // handle nested previous words
  if (previousWord && Array.isArray(previousWord[0])) {
    var nestedPreviousWord = getDeepNestedWords(previousWord); // get the last item in the array

    previousWord = nestedPreviousWord[nestedPreviousWord.length - 1];
  } // handle nested next words


  if (nextWord) {
    if (Array.isArray(nextWord) || Array.isArray(nextWord[0])) {
      var nestedNextWords = getDeepNestedWords(nextWord);
      nextWord = nestedNextWords[0];
    }
  }

  var isPreviousWordMatch = previousWord && previousWord.content ? isWordArrayMatch(previousWord, contextId) : isWordMatch(previousWord, contextId, words, index - 1);
  var isNextWordMatch = nextWord && nextWord.content ? isWordArrayMatch(nextWord, contextId) : isWordMatch(nextWord, contextId, words, index + 1);

  if (previousWord && nextWord) {
    return isPreviousWordMatch && isNextWordMatch;
  } else if (previousWord) {
    return isPreviousWordMatch;
  } else if (nextWord) {
    return isNextWordMatch;
  } else {
    return false;
  }
}

var spaceCounter = 0;
/**
 * pushes a span to the array
 * @param {Array} verseSpan
 */

function addSpace(verseSpan) {
  verseSpan.push(_react["default"].createElement("span", {
    key: 'space_' + ++spaceCounter,
    style: {
      backgroundColor: 'transparent'
    }
  }, ' '));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9TY3JpcHR1cmVQYW5lL2hlbHBlcnMvaGlnaGxpZ2h0SGVscGVycy5qcyJdLCJuYW1lcyI6WyJpc1dvcmRBcnJheU1hdGNoIiwid29yZCIsImNvbnRleHRJZCIsImlzTWF0Y2giLCJjb250ZW50IiwiQXJyYXkiLCJpc0FycmF5IiwicXVvdGUiLCJzb21lIiwid29yZEl0ZW0iLCJmb3VuZE1hdGNoIiwiaSIsImwiLCJsZW5ndGgiLCJvY2N1cnJlbmNlIiwic3BsaXQiLCJpbmNsdWRlcyIsInN0cmluZ09jY3VycmVuY2UiLCJnZXRPY2N1cnJlbmNlT2ZXb3JkIiwiaW5kZXgiLCJ3b3JkcyIsIndvcmRUZXh0IiwiX29jY3VycmVuY2UiLCJ0eXBlIiwidGV4dCIsImlzV29yZE1hdGNoIiwicmVwbGFjZSIsIm5ld1dvcmRzIiwiSlNPTiIsInBhcnNlIiwic3RyaW5naWZ5Iiwid29yZHNXaXRob3V0QXBvc3Ryb3BoZSIsInB1c2giLCJxdW90ZXMiLCJlIiwiY29uc29sZSIsImVycm9yIiwiZ2V0V29yZEhpZ2hsaWdodGVkRGV0YWlscyIsInByZXZpb3VzV29yZCIsImlzSGlnaGxpZ2h0ZWRXb3JkIiwiaXNCZXR3ZWVuSGlnaGxpZ2h0ZWRXb3JkIiwiZ2V0V29yZHNGcm9tTmVzdGVkTWlsZXN0b25lIiwibmVzdGVkV29yZHMiLCJ3b3JkU3BhY2luZyIsImdldERlZXBOZXN0ZWRXb3JkcyIsIm5lc3RlZFByZXZpb3VzV29yZCIsIm5lc3RlZFdvcmRTcGFjaW5nIiwid29yZFNwYW5zIiwibGVuIiwibmVzdGVkV29yZCIsIm5lc3RlZFdvcmRJbmRleCIsIndvcmRzQXJyYXkiLCJuZXN0ZWRXb3JkU3BhbkluZGV4IiwidG9TdHJpbmciLCJuZXN0ZWROZXh0V29yZCIsInBhZGRpbmciLCJpc1B1bnR1YXRpb25BbmROZWVkc05vU3BhY2UiLCJoaWdobGlnaHRlZERldGFpbHMiLCJwYWRkaW5nU3BhblN0eWxlIiwiYmFja2dyb3VuZENvbG9yIiwiaXNQdW5jdHVhdGlvbkhpZ2hsaWdodGVkIiwid29yZE9iamVjdCIsImRlZXBOZXN0ZWRXb3JkcyIsIm5leHRXb3JkIiwibmVzdGVkTmV4dFdvcmRzIiwiaXNQcmV2aW91c1dvcmRNYXRjaCIsImlzTmV4dFdvcmRNYXRjaCIsInNwYWNlQ291bnRlciIsImFkZFNwYWNlIiwidmVyc2VTcGFuIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRU8sU0FBU0EsZ0JBQVQsQ0FBMEJDLElBQTFCLEVBQWdDQyxTQUFoQyxFQUEyQztBQUNoRCxNQUFJQyxPQUFPLEdBQUcsS0FBZDs7QUFFQSxNQUFJRixJQUFJLElBQUlBLElBQUksQ0FBQ0csT0FBYixJQUF3QkMsS0FBSyxDQUFDQyxPQUFOLENBQWNMLElBQUksQ0FBQ0csT0FBbkIsQ0FBeEIsSUFBdURGLFNBQXZELElBQW9FQSxTQUFTLENBQUNLLEtBQWxGLEVBQXlGO0FBQ3ZGSixJQUFBQSxPQUFPLEdBQUdGLElBQUksQ0FBQ0csT0FBTCxDQUFhSSxJQUFiLENBQWtCLFVBQUFDLFFBQVEsRUFBSTtBQUN0QyxVQUFJQyxVQUFVLEdBQUcsS0FBakI7O0FBRUEsVUFBSUwsS0FBSyxDQUFDQyxPQUFOLENBQWNKLFNBQVMsQ0FBQ0ssS0FBeEIsQ0FBSixFQUFvQztBQUNsQyxhQUFLLElBQUlJLENBQUMsR0FBRyxDQUFSLEVBQVdDLENBQUMsR0FBR1YsU0FBUyxDQUFDSyxLQUFWLENBQWdCTSxNQUFwQyxFQUE0Q0YsQ0FBQyxHQUFHQyxDQUFoRCxFQUFtREQsQ0FBQyxFQUFwRCxFQUF3RDtBQUN0RCxjQUFNSixLQUFLLEdBQUdMLFNBQVMsQ0FBQ0ssS0FBVixDQUFnQkksQ0FBaEIsQ0FBZDs7QUFFQSxjQUFLSixLQUFLLENBQUNOLElBQU4sS0FBZVEsUUFBUSxDQUFDTCxPQUF6QixJQUFzQ0csS0FBSyxDQUFDTyxVQUFOLEtBQXFCTCxRQUFRLENBQUNLLFVBQXhFLEVBQXFGO0FBQ25GSixZQUFBQSxVQUFVLEdBQUcs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RUFBRTtBQUFFUixNQUFBQSxlQUFlLEVBQUU7QUFBbkI7QUFBOUMsS0FDRyxHQURILENBREY7QUFLRCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgaXNFcXVhbCBmcm9tICdsb2Rhc2gvaXNFcXVhbCc7XG5pbXBvcnQgeyBpc1dvcmQsIHB1bmN0dWF0aW9uV29yZFNwYWNpbmcgfSBmcm9tICcuL3N0cmluZ0hlbHBlcnMnO1xuaW1wb3J0IHsgcmVtb3ZlTWFya2VyIH0gZnJvbSAnLi91c2ZtSGVscGVycyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1dvcmRBcnJheU1hdGNoKHdvcmQsIGNvbnRleHRJZCkge1xuICBsZXQgaXNNYXRjaCA9IGZhbHNlO1xuXG4gIGlmICh3b3JkICYmIHdvcmQuY29udGVudCAmJiBBcnJheS5pc0FycmF5KHdvcmQuY29udGVudCkgJiYgY29udGV4dElkICYmIGNvbnRleHRJZC5xdW90ZSkge1xuICAgIGlzTWF0Y2ggPSB3b3JkLmNvbnRlbnQuc29tZSh3b3JkSXRlbSA9PiB7XG4gICAgICBsZXQgZm91bmRNYXRjaCA9IGZhbHNlO1xuXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShjb250ZXh0SWQucXVvdGUpKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gY29udGV4dElkLnF1b3RlLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgIGNvbnN0IHF1b3RlID0gY29udGV4dElkLnF1b3RlW2ldO1xuXG4gICAgICAgICAgaWYgKChxdW90ZS53b3JkID09PSB3b3JkSXRlbS5jb250ZW50KSAmJiAocXVvdGUub2NjdXJyZW5jZSA9PT0gd29yZEl0ZW0ub2NjdXJyZW5jZSkpIHtcbiAgICAgICAgICAgIGZvdW5kTWF0Y2ggPSB0cnVlO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGNvbnRleHRJZC5xdW90ZS5zcGxpdCgnICcpLmluY2x1ZGVzKHdvcmRJdGVtLmNvbnRlbnQpKSB7XG4gICAgICAgIGxldCBzdHJpbmdPY2N1cnJlbmNlID0gY29udGV4dElkLm9jY3VycmVuY2U7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmdPY2N1cnJlbmNlID09PSAnc3RyaW5nJyAmJiBzdHJpbmdPY2N1cnJlbmNlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHN0cmluZ09jY3VycmVuY2UgPSAxO1xuICAgICAgICB9XG4gICAgICAgIGZvdW5kTWF0Y2ggPSAoc3RyaW5nT2NjdXJyZW5jZSA9PT0gd29yZEl0ZW0ub2NjdXJyZW5jZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZm91bmRNYXRjaDtcbiAgICB9KTtcbiAgfVxuICByZXR1cm4gaXNNYXRjaDtcbn1cblxuLyoqXG4gKiBzZWFyY2ggd29yZCBsaXN0IHRvIGZpbmQgb2NjdXJyZW5jZSBvZiB3b3JkXG4gKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBwb3NpdGlvbiBvZiB3b3JkXG4gKiBAcGFyYW0ge0FycmF5fSB3b3JkcyAtIGxpc3Qgb2Ygd29yZCBvYmplY3RzIHRvIHNlYXJjaFxuICogQHBhcmFtIHtTdHJpbmd9IHdvcmRUZXh0IC0gdGV4dCB0byBtYXRjaFxuICogQHBhcmFtIHtudW1iZXJ9IG9jY3VycmVuY2UgLSB0byBtYXRjaFxuICogQHJldHVybiB7Qm9vbGVhbn0gLSB0cnVlIGlmIHNhbWUgb2NjdXJyZW5jZVxuICovXG5mdW5jdGlvbiBnZXRPY2N1cnJlbmNlT2ZXb3JkKGluZGV4LCB3b3Jkcywgd29yZFRleHQsIG9jY3VycmVuY2UpIHtcbi8vIGdldCBvY2N1cnJlbmNlIG9mIHdvcmRcbiAgbGV0IF9vY2N1cnJlbmNlID0gMDtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8PSBpbmRleDsgaSsrKSB7XG4gICAgY29uc3Qgd29yZEl0ZW0gPSB3b3Jkc1tpXTtcblxuICAgIGlmICgod29yZEl0ZW0udHlwZSA9PT0gJ3dvcmQnKSAmJiAod29yZEl0ZW0udGV4dCA9PT0gd29yZFRleHQpKSB7XG4gICAgICBfb2NjdXJyZW5jZSsrO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGlzTWF0Y2ggPSAoX29jY3VycmVuY2UgPT09IG9jY3VycmVuY2UpO1xuICByZXR1cm4gaXNNYXRjaDtcbn1cblxuLyoqXG4gKiBzZWUgaWYgdGhpcyB3b3JkIGlzIHBhcnQgb2YgcXVvdGUgZm9yIGN1cnJlbnQgY29udGV4dCBpZC5cbiAqIEBwYXJhbSB7T2JqZWN0fSB3b3JkXG4gKiBAcGFyYW0ge09iamVjdH0gY29udGV4dElkXG4gKiBAcGFyYW0ge0FycmF5fSB3b3Jkc1xuICogQHBhcmFtIHtudW1iZXJ9IGluZGV4XG4gKiBAcmV0dXJuIHtib29sZWFufSAtIHRydWUgaWYgaW4gcXVvdGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGlzV29yZE1hdGNoKHdvcmQsIGNvbnRleHRJZCwgd29yZHMsIGluZGV4KSB7XG4gIGxldCBpc01hdGNoID0gZmFsc2U7XG5cbiAgdHJ5IHtcbiAgICBpZiAod29yZCAmJiB3b3JkLnRleHQgJiYgY29udGV4dElkICYmIGNvbnRleHRJZC5xdW90ZSkge1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29udGV4dElkLnF1b3RlKSkge1xuICAgICAgICAvLyBpZiBsaXN0IG9mIHdvcmRzIGluIHF1b3RlIHNlZSBpZiB0aGlzIHdvcmQgbWF0Y2hlcyBvbmUgb2YgdGhlIHdvcmRzXG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gY29udGV4dElkLnF1b3RlLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgIGNvbnN0IHF1b3RlID0gY29udGV4dElkLnF1b3RlW2ldO1xuXG4gICAgICAgICAgaWYgKHF1b3RlLndvcmQgPT09IHdvcmQudGV4dCkge1xuICAgICAgICAgICAgaXNNYXRjaCA9IGdldE9jY3VycmVuY2VPZldvcmQoaW5kZXgsIHdvcmRzLCB3b3JkLnRleHQsIHF1b3RlLm9jY3VycmVuY2UpO1xuXG4gICAgICAgICAgICBpZiAoaXNNYXRjaCkge1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2UgaWYgKHdvcmQudGV4dCAmJiB3b3JkLnRleHQuaW5jbHVkZXMoJ+KAmScpICYmIHdvcmQudGV4dC5yZXBsYWNlKCfigJknLCAnJykgPT09IHF1b3RlLndvcmQpIHtcbiAgICAgICAgICAgIGNvbnN0IHdvcmRUZXh0ID0gd29yZC50ZXh0LnJlcGxhY2UoJ+KAmScsICcnKTtcbiAgICAgICAgICAgIC8vIERlZXAgY2xvbmluZyBhcnJheSB0byBhdm9pZCByZWZlcmVuY2luZyB0aGUgb2xkIGFycmF5IGFkZHJlc3MgaW4gbWVtb3J5XG4gICAgICAgICAgICBjb25zdCBuZXdXb3JkcyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkod29yZHMpKTtcbiAgICAgICAgICAgIC8vIHJlbW92ZSBhcG9zdHJvcGhlIGZyb20gZWFjaCB3b3JkIGluIHRoZSB3b3JkcyBhcnJheVxuICAgICAgICAgICAgY29uc3Qgd29yZHNXaXRob3V0QXBvc3Ryb3BoZSA9IFtdO1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBpbmRleDsgaSsrKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHdvcmRJdGVtID0gbmV3V29yZHNbaV07XG5cbiAgICAgICAgICAgICAgaWYgKHdvcmRJdGVtLnRleHQgJiYgd29yZEl0ZW0udGV4dC5pbmNsdWRlcygn4oCZJykpIHtcbiAgICAgICAgICAgICAgICB3b3JkSXRlbS50ZXh0ID0gd29yZEl0ZW0udGV4dC5yZXBsYWNlKCfigJknLCAnJyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgd29yZHNXaXRob3V0QXBvc3Ryb3BoZS5wdXNoKHdvcmRJdGVtKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaXNNYXRjaCA9IGdldE9jY3VycmVuY2VPZldvcmQoaW5kZXgsIHdvcmRzV2l0aG91dEFwb3N0cm9waGUsIHdvcmRUZXh0LCBxdW90ZS5vY2N1cnJlbmNlKTtcblxuICAgICAgICAgICAgaWYgKGlzTWF0Y2gpIHtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgeyAvLyBpcyBzdHJpbmcgd2l0aCBvbmUgb3IgbW9yZSB3b3Jkc1xuICAgICAgICBjb25zdCBxdW90ZXMgPSBjb250ZXh0SWQucXVvdGUuc3BsaXQoJyAnKTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHF1b3Rlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICBjb25zdCBxdW90ZSA9IHF1b3Rlc1tpXTtcblxuICAgICAgICAgIGlmIChxdW90ZSA9PT0gd29yZC50ZXh0KSB7XG4gICAgICAgICAgICBpc01hdGNoID0gZ2V0T2NjdXJyZW5jZU9mV29yZChpbmRleCwgd29yZHMsIHF1b3RlLCBjb250ZXh0SWQub2NjdXJyZW5jZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBpc01hdGNoO1xuICB9IGNhdGNoIChlKSB7XG4gICAgY29uc29sZS5lcnJvcihlKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0V29yZEhpZ2hsaWdodGVkRGV0YWlscyhjb250ZXh0SWQsIHByZXZpb3VzV29yZCwgd29yZCkge1xuICBjb25zdCBpc0hpZ2hsaWdodGVkV29yZCA9IGlzV29yZEFycmF5TWF0Y2god29yZCwgY29udGV4dElkKTtcbiAgY29uc3QgaXNCZXR3ZWVuSGlnaGxpZ2h0ZWRXb3JkID0gaXNIaWdobGlnaHRlZFdvcmQgJiYgcHJldmlvdXNXb3JkICYmICFpc0VxdWFsKHByZXZpb3VzV29yZCwgd29yZClcbiAgICAgICYmIGlzV29yZEFycmF5TWF0Y2gocHJldmlvdXNXb3JkLCBjb250ZXh0SWQpO1xuICByZXR1cm4ge1xuICAgIGlzSGlnaGxpZ2h0ZWRXb3JkLFxuICAgIGlzQmV0d2VlbkhpZ2hsaWdodGVkV29yZCxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFdvcmRzRnJvbU5lc3RlZE1pbGVzdG9uZShuZXN0ZWRXb3JkcywgY29udGV4dElkLCBpbmRleCwgcHJldmlvdXNXb3JkLCB3b3JkU3BhY2luZykge1xuICAvLyBpZiBpdHMgYW4gYXJyYXkgb2YgYW4gYXJyYXkgdGh1cyBnZXQgZGVlcCBuZXN0ZWQgd29yZHMgYXJyYXkuXG4gIGlmIChBcnJheS5pc0FycmF5KG5lc3RlZFdvcmRzWzBdKSkge1xuICAgIG5lc3RlZFdvcmRzID0gZ2V0RGVlcE5lc3RlZFdvcmRzKG5lc3RlZFdvcmRzKTtcbiAgfVxuXG4gIGxldCBpc0hpZ2hsaWdodGVkV29yZCA9IGZhbHNlO1xuICBsZXQgaXNCZXR3ZWVuSGlnaGxpZ2h0ZWRXb3JkID0gZmFsc2U7XG4gIGxldCBuZXN0ZWRQcmV2aW91c1dvcmQgPSBwcmV2aW91c1dvcmQ7XG4gIGxldCBuZXN0ZWRXb3JkU3BhY2luZyA9IHdvcmRTcGFjaW5nO1xuICBjb25zdCB3b3JkU3BhbnMgPVtdO1xuXG4gIGZvciAobGV0IGkgPSAwLCBsZW4gPSBuZXN0ZWRXb3Jkcy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgIGNvbnN0IG5lc3RlZFdvcmQgPSBuZXN0ZWRXb3Jkc1tpXTtcbiAgICBjb25zdCBuZXN0ZWRXb3JkSW5kZXggPSBpO1xuICAgIGNvbnN0IHdvcmRzQXJyYXkgPSBuZXN0ZWRXb3JkcztcblxuICAgIGNvbnN0IG5lc3RlZFdvcmRTcGFuSW5kZXggPSBgJHtpbmRleC50b1N0cmluZygpfV8ke25lc3RlZFdvcmRJbmRleC50b1N0cmluZygpfV8ke25lc3RlZFdvcmQudGV4dH1gO1xuICAgIGNvbnN0IG5lc3RlZE5leHRXb3JkID0gd29yZHNBcnJheVtpbmRleCArIDFdO1xuXG4gICAgaWYgKGlzV29yZChuZXN0ZWRXb3JkKSkge1xuICAgICAgbGV0IHBhZGRpbmcgPSBuZXN0ZWRXb3JkU3BhY2luZztcbiAgICAgIG5lc3RlZFdvcmRTcGFjaW5nID0gJyAnOyAvLyBzcGFjaW5nIGJldHdlZW4gd29yZHNcblxuICAgICAgaWYgKG5lc3RlZFByZXZpb3VzV29yZCAmJiBpc1B1bnR1YXRpb25BbmROZWVkc05vU3BhY2UobmVzdGVkUHJldmlvdXNXb3JkKSkge1xuICAgICAgICBwYWRkaW5nID0gJyc7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGhpZ2hsaWdodGVkRGV0YWlscyA9IGdldFdvcmRIaWdobGlnaHRlZERldGFpbHMoXG4gICAgICAgIGNvbnRleHRJZCxcbiAgICAgICAgbmVzdGVkUHJldmlvdXNXb3JkLFxuICAgICAgICBuZXN0ZWRXb3JkLFxuICAgICAgKTtcbiAgICAgIGlzSGlnaGxpZ2h0ZWRXb3JkID0gaGlnaGxpZ2h0ZWREZXRhaWxzLmlzSGlnaGxpZ2h0ZWRXb3JkO1xuICAgICAgaXNCZXR3ZWVuSGlnaGxpZ2h0ZWRXb3JkID0gaGlnaGxpZ2h0ZWREZXRhaWxzLmlzQmV0d2VlbkhpZ2hsaWdodGVkV29yZDtcbiAgICAgIG5lc3RlZFByZXZpb3VzV29yZCA9IG5lc3RlZFdvcmQ7XG4gICAgICBjb25zdCBwYWRkaW5nU3BhblN0eWxlID0geyBiYWNrZ3JvdW5kQ29sb3I6IGlzQmV0d2VlbkhpZ2hsaWdodGVkV29yZCA/ICd2YXIoLS1oaWdobGlnaHQtY29sb3IpJyA6ICd0cmFuc3BhcmVudCcgfTtcblxuICAgICAgd29yZFNwYW5zLnB1c2goXG4gICAgICAgIDxzcGFuIGtleT17bmVzdGVkV29yZFNwYW5JbmRleC50b1N0cmluZygpfT5cbiAgICAgICAgICA8c3BhbiBzdHlsZT17cGFkZGluZ1NwYW5TdHlsZX0+XG4gICAgICAgICAgICB7cGFkZGluZ31cbiAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgPHNwYW4gc3R5bGU9e3sgYmFja2dyb3VuZENvbG9yOiBpc0hpZ2hsaWdodGVkV29yZCA/ICd2YXIoLS1oaWdobGlnaHQtY29sb3IpJyA6ICcnIH19PlxuICAgICAgICAgICAge3JlbW92ZU1hcmtlcihuZXN0ZWRXb3JkLnRleHQpfVxuICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgPC9zcGFuPixcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChuZXN0ZWRXb3JkLnRleHQpIHtcbiAgICAgIG5lc3RlZFdvcmRTcGFjaW5nID0gcHVuY3R1YXRpb25Xb3JkU3BhY2luZyhuZXN0ZWRXb3JkKTsgLy8gc3BhY2luZyBiZWZvcmUgd29yZHNcbiAgICAgIGNvbnN0IHRleHQgPSByZW1vdmVNYXJrZXIobmVzdGVkV29yZC50ZXh0KTtcblxuICAgICAgaWYgKGlzUHVuY3R1YXRpb25IaWdobGlnaHRlZChuZXN0ZWRQcmV2aW91c1dvcmQsIG5lc3RlZE5leHRXb3JkLCBjb250ZXh0SWQpKSB7XG4gICAgICAgIHdvcmRTcGFucy5wdXNoKFxuICAgICAgICAgIDxzcGFuIGtleT17bmVzdGVkV29yZFNwYW5JbmRleH0gc3R5bGU9e3sgYmFja2dyb3VuZENvbG9yOiAndmFyKC0taGlnaGxpZ2h0LWNvbG9yKScgfX0+XG4gICAgICAgICAgICB7dGV4dH1cbiAgICAgICAgICA8L3NwYW4+LFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd29yZFNwYW5zLnB1c2goXG4gICAgICAgICAgPHNwYW4ga2V5PXtuZXN0ZWRXb3JkU3BhbkluZGV4fT5cbiAgICAgICAgICAgIHt0ZXh0fVxuICAgICAgICAgIDwvc3Bhbj4sXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHtcbiAgICB3b3JkU3BhbnMsXG4gICAgbmVzdGVkUHJldmlvdXNXb3JkLFxuICAgIG5lc3RlZFdvcmRTcGFjaW5nLFxuICB9O1xufVxuXG4vKipcbiAqIERldGVybWluZXMgaWYgdGhlIHByZXZpb3VzIHdvcmQgaXMgYSBwdW5jdHVhdGlvbiB0aGF0XG4gKiBkb2VzbnQgbmVlZCBzcGFjaW5nIGFmdGVyIGl0LlxuICogQHBhcmFtIHtPYmplY3R9IHdvcmRPYmplY3RcbiAqL1xuZnVuY3Rpb24gaXNQdW50dWF0aW9uQW5kTmVlZHNOb1NwYWNlKHdvcmRPYmplY3QpIHtcbiAgcmV0dXJuICFpc1dvcmQod29yZE9iamVjdCkgJiYgKHdvcmRPYmplY3QudGV4dCA9PT0gJ1wiJykgfHwgKHdvcmRPYmplY3QudGV4dCA9PT0gJ1xcJycpO1xufVxuXG4vKipcbiAqIEdldHMgYSB3b3JkcyBvYmplY3QgYXJyYXkgZnJvbSBhIGRlZXAgbmVzdGVkIG1pbGVzdG9uZS5cbiAqIEBwYXJhbSB7YXJyYXl9IG5lc3RlZFdvcmRzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXREZWVwTmVzdGVkV29yZHMobmVzdGVkV29yZHMpIHtcbiAgbGV0IGRlZXBOZXN0ZWRXb3JkcyA9IG51bGw7XG5cbiAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IG5lc3RlZFdvcmRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgY29uc3QgbmVzdGVkV29yZCA9IG5lc3RlZFdvcmRzW2ldO1xuXG4gICAgaWYgKG5lc3RlZFdvcmQudGV4dCkge1xuICAgICAgZGVlcE5lc3RlZFdvcmRzID0gbmVzdGVkV29yZHM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRlZXBOZXN0ZWRXb3JkcyA9IGdldERlZXBOZXN0ZWRXb3JkcyhuZXN0ZWRXb3JkKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZGVlcE5lc3RlZFdvcmRzO1xufVxuXG4vKipcbiAqIERldGVybWluZXMgaWYgYSBwdW5jdHVhdGlvbiBzaG91bGQgYmUgaGlnaGxpZ2h0ZWQgb3Igbm90LlxuICogQHBhcmFtIHtvYmplY3R9IHByZXZpb3VzV29yZFxuICogQHBhcmFtIHtvYmplY3R9IG5leHRXb3JkXG4gKiBAcGFyYW0ge29iamVjdH0gY29udGV4dElkXG4gKiBAcmV0dXJucyB7Ym9vbH0gdHJ1ZSBvciBmYWxzZS4gaGlnaGxpZ2h0ZWQgb3Igbm90IGhpZ2hsaWdodGVkLlxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNQdW5jdHVhdGlvbkhpZ2hsaWdodGVkKHByZXZpb3VzV29yZCwgbmV4dFdvcmQsIGNvbnRleHRJZCwgd29yZHMsIGluZGV4KSB7XG4gIC8vIGhhbmRsZSBuZXN0ZWQgcHJldmlvdXMgd29yZHNcbiAgaWYgKHByZXZpb3VzV29yZCAmJiBBcnJheS5pc0FycmF5KHByZXZpb3VzV29yZFswXSkpIHtcbiAgICBjb25zdCBuZXN0ZWRQcmV2aW91c1dvcmQgPSBnZXREZWVwTmVzdGVkV29yZHMocHJldmlvdXNXb3JkKTtcbiAgICAvLyBnZXQgdGhlIGxhc3QgaXRlbSBpbiB0aGUgYXJyYXlcbiAgICBwcmV2aW91c1dvcmQgPSBuZXN0ZWRQcmV2aW91c1dvcmRbbmVzdGVkUHJldmlvdXNXb3JkLmxlbmd0aCAtIDFdO1xuICB9XG5cbiAgLy8gaGFuZGxlIG5lc3RlZCBuZXh0IHdvcmRzXG4gIGlmIChuZXh0V29yZCkge1xuICAgIGlmIChBcnJheS5pc0FycmF5KG5leHRXb3JkKSB8fCBBcnJheS5pc0FycmF5KG5leHRXb3JkWzBdKSkge1xuICAgICAgbGV0IG5lc3RlZE5leHRXb3JkcyA9IGdldERlZXBOZXN0ZWRXb3JkcyhuZXh0V29yZCk7XG4gICAgICBuZXh0V29yZCA9IG5lc3RlZE5leHRXb3Jkc1swXTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBpc1ByZXZpb3VzV29yZE1hdGNoID0gcHJldmlvdXNXb3JkICYmIHByZXZpb3VzV29yZC5jb250ZW50ID9cbiAgICBpc1dvcmRBcnJheU1hdGNoKHByZXZpb3VzV29yZCwgY29udGV4dElkKSA6IGlzV29yZE1hdGNoKHByZXZpb3VzV29yZCwgY29udGV4dElkLCB3b3JkcywgaW5kZXggLSAxKTtcbiAgY29uc3QgaXNOZXh0V29yZE1hdGNoID0gbmV4dFdvcmQgJiYgbmV4dFdvcmQuY29udGVudCA/XG4gICAgaXNXb3JkQXJyYXlNYXRjaChuZXh0V29yZCwgY29udGV4dElkKSA6IGlzV29yZE1hdGNoKG5leHRXb3JkLCBjb250ZXh0SWQsIHdvcmRzLCBpbmRleCArIDEpO1xuXG4gIGlmIChwcmV2aW91c1dvcmQgJiYgbmV4dFdvcmQpIHtcbiAgICByZXR1cm4gaXNQcmV2aW91c1dvcmRNYXRjaCAmJiBpc05leHRXb3JkTWF0Y2g7XG4gIH0gZWxzZSBpZiAocHJldmlvdXNXb3JkKSB7XG4gICAgcmV0dXJuIGlzUHJldmlvdXNXb3JkTWF0Y2g7XG4gIH0gZWxzZSBpZiAobmV4dFdvcmQpIHtcbiAgICByZXR1cm4gaXNOZXh0V29yZE1hdGNoO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG5sZXQgc3BhY2VDb3VudGVyID0gMDtcblxuLyoqXG4gKiBwdXNoZXMgYSBzcGFuIHRvIHRoZSBhcnJheVxuICogQHBhcmFtIHtBcnJheX0gdmVyc2VTcGFuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhZGRTcGFjZSh2ZXJzZVNwYW4pIHtcbiAgdmVyc2VTcGFuLnB1c2goXG4gICAgPHNwYW4ga2V5PXsnc3BhY2VfJyArKCsrc3BhY2VDb3VudGVyKX0gc3R5bGU9e3sgYmFja2dyb3VuZENvbG9yOiAndHJhbnNwYXJlbnQnIH19PlxuICAgICAgeycgJ31cbiAgICA8L3NwYW4+LFxuICApO1xufVxuIl19