"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getGroupData = getGroupData;
exports.scrollIntoView = scrollIntoView;
exports.scrollIntoViewEnd = scrollIntoViewEnd;
exports.inView = inView;
exports.isInViewport = isInViewport;
exports.getStatusBadges = getStatusBadges;
exports.makeStatusBadgeComponents = makeStatusBadgeComponents;
exports.getGlyphIcons = getGlyphIcons;
exports.groupIsVisible = exports.groupItemIsVisible = exports.getFilterCount = exports.MENU_ITEM_HEIGHT = exports.MENU_BAR_HEIGHT = void 0;

var _react = _interopRequireDefault(require("react"));

var _server = _interopRequireDefault(require("react-dom/server"));

var _reactBootstrap = require("react-bootstrap");

var _InvalidatedIcon = _interopRequireDefault(require("../GroupsMenuFilter/InvalidatedIcon"));

var MENU_BAR_HEIGHT = 30;
exports.MENU_BAR_HEIGHT = MENU_BAR_HEIGHT;
var MENU_ITEM_HEIGHT = 38;
exports.MENU_ITEM_HEIGHT = MENU_ITEM_HEIGHT;

function getGroupData(groupsData, groupId) {
  var groupData;

  if (groupsData !== undefined) {
    groupData = groupsData[groupId];
  }

  return groupData;
}

var getFilterCount = function getFilterCount(filters) {
  return Object.keys(filters).filter(function (k) {
    return filters[k];
  }).length;
};
/**
 * @description - Determines if the item should be navigatable
 * @param {object} groupItemData
 * @returns {boolean}
 */


exports.getFilterCount = getFilterCount;

var groupItemIsVisible = function groupItemIsVisible(groupItemData, filters) {
  return !getFilterCount(filters) || filters.invalidated && groupItemData.invalidated || filters.reminders && groupItemData.reminders || filters.selections && groupItemData.selections || filters.noSelections && !groupItemData.selections || filters.verseEdits && groupItemData.verseEdits || filters.comments && groupItemData.comments;
};
/**
 * @description - Determines if the group is navigatable based on filters
 * @param {object} groupData
 * @returns {boolean}
 */


exports.groupItemIsVisible = groupItemIsVisible;

var groupIsVisible = function groupIsVisible(groupData, filters) {
  if (!getFilterCount(filters)) {
    return true;
  }

  for (var i = 0, len = groupData.length; i < len; i++) {
    var groupItemData = groupData[i];

    if (groupItemIsVisible(groupItemData, filters)) {
      return true;
    }
  }

  return false;
};
/**
 * scrolls into view, but will be toward top
 * @param {object} current
 */


exports.groupIsVisible = groupIsVisible;

function scrollIntoView(_ref) {
  var current = _ref.current;

  if (current && current.scrollIntoView) {
    current.scrollIntoView({
      block: 'start',
      behavior: 'smooth'
    });
  }
}
/**
 * scrolls into view, but will be toward bottom
 * @param {object} item
 */


function scrollIntoViewEnd(_ref2) {
  var current = _ref2.current;

  if (current && current.scrollIntoView) {
    current.scrollIntoView(false); // must use boolean value here because we are using an older chromium that does not yet support scrollIntoViewOptions
  }
}
/**
 *
* @description - Tests if the the two elements are in the scope of the window (scroll bar)
* The consts MENU_BAR_HEIGHT & MENU_ITEM_HEIGHT are set to account for the static window avialablity
* @param {object} currentGroupMenu - The current group menu header that is extended/actived (i.e. Metaphors)
* @param {object} currentGroupItem - The current group check item that is active (i.e. Luke 1:1)
*/


function inView(_ref3, _ref4) {
  var currentGroupMenu = _ref3.current;
  var currentGroupItem = _ref4.current;

  if (currentGroupMenu && currentGroupItem) {
    var rectGroup = currentGroupMenu.getBoundingClientRect();
    var rectItem = currentGroupItem.getBoundingClientRect();
    var viewHeight = Math.min(document.documentElement.clientHeight, window.innerHeight);
    return Math.abs(rectGroup.top - rectItem.top) + (MENU_BAR_HEIGHT + MENU_ITEM_HEIGHT * 2) <= viewHeight;
  }
}
/**
 * Checks if the react ref is vertically within the viewport.
 * @param ref - the react ref
 * @return {boolean}
 */


function isInViewport(ref) {
  if (ref && ref.current) {
    var offset = MENU_BAR_HEIGHT + MENU_ITEM_HEIGHT;
    var top = ref.current.getBoundingClientRect().top;
    return top >= 0 && top + offset <= window.innerHeight;
  } else {
    return false;
  }
}
/**
 * @description - gets the status badge component for the group menu row
 * @param {object} groupItemData
 * @param verseFinished
 * @param verseIsValid
 */


function getStatusBadges(groupItemData, verseFinished, verseIsValid) {
  var glyphs = [];

  if (groupItemData && groupItemData.contextId && groupItemData.contextId.reference) {
    // The below ifs are in order of precedence of the status badges we show
    if (groupItemData.invalidated || !verseIsValid) {
      glyphs.push('invalidated');
    }

    if (groupItemData.reminders) {
      glyphs.push('bookmark');
    }

    if (groupItemData.selections || verseFinished) {
      glyphs.push('ok');
    }

    if (groupItemData.verseEdits) {
      glyphs.push('pencil');
    }

    if (groupItemData.comments) {
      glyphs.push('comment');
    }
  }

  return makeStatusBadgeComponents(glyphs);
}
/**
 * @description - Takes an array of glyph names, gets their React components and then renders the status badge
 * with the first icon and then a mouse-over tooltip with the rest of the icons and a chip to say how many icons there are.
 * @param {*} glyphs
 */


function makeStatusBadgeComponents(glyphs) {
  var statusGlyphs = getGlyphIcons(glyphs);
  var mainGlyph = statusGlyphs[0];

  if (statusGlyphs.length > 1) {
    var tooltip = _server["default"].renderToString(statusGlyphs);

    return _react["default"].createElement("div", {
      className: "status-badge-wrapper"
    }, _react["default"].createElement("div", {
      className: "status-badge",
      "data-for": "groups-tooltip",
      "data-tip": tooltip,
      "data-html": "true",
      "data-place": "bottom",
      "data-effect": "float",
      "data-type": "light",
      "data-class": "group-menu-status-tooltip",
      "data-delay-hide": "100"
    }, mainGlyph, _react["default"].createElement("div", {
      className: "badge"
    }, statusGlyphs.length)));
  } else {
    return _react["default"].createElement("div", {
      className: "status-badge-wrapper"
    }, _react["default"].createElement("div", {
      className: "status-badge"
    }, mainGlyph));
  }
}
/**
 * @description - Takes an array of strings that are glyph names and gets the proper React component to render them
 * @param {array} glyphs
 */


function getGlyphIcons(glyphs) {
  var glyphicons = [];

  if (glyphs && glyphs.length) {
    for (var i = 0, len = glyphs.length; i < len; i++) {
      var glyph = glyphs[i];

      if (glyph === 'invalidated') {
        glyphicons.push(_react["default"].createElement("div", {
          key: glyph,
          className: 'glyphicon glyphicon-invalidated'
        }, _react["default"].createElement(_InvalidatedIcon["default"], {
          height: 16,
          width: 16
        })));
      } else {
        var className = 'status-icon-' + glyph;
        glyphicons.push(_react["default"].createElement(_reactBootstrap.Glyphicon, {
          key: glyph,
          glyph: glyph,
          className: className
        }));
      }
    }
  } else {
    glyphicons.push(_react["default"].createElement("div", {
      key: "blank",
      className: "glyphicon glyphicon-blank status-icon-blank"
    }));
  }

  return glyphicons;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9Hcm91cE1lbnUvaGVscGVycy9pbmRleC5qcyJdLCJuYW1lcyI6WyJNRU5VX0JBUl9IRUlHSFQiLCJNRU5VX0lURU1fSEVJR0hUIiwiZ2V0R3JvdXBEYXRhIiwiZ3JvdXBzRGF0YSIsImdyb3VwSWQiLCJncm91cERhdGEiLCJ1bmRlZmluZWQiLCJnZXRGaWx0ZXJDb3VudCIsImZpbHRlcnMiLCJPYmplY3QiLCJrZXlzIiwiZmlsdGVyIiwiayIsImxlbmd0aCIsImdyb3VwSXRlbUlzVmlzaWJsZSIsImdyb3VwSXRlbURhdGEiLCJpbnZhbGlkYXRlZCIsInJlbWluZGVycyIsInNlbGVjdGlvbnMiLCJub1NlbGVjdGlvbnMiLCJ2ZXJzZUVkaXRzIiwiY29tbWVudHMiLCJncm91cElzVmlzaWJsZSIsImkiLCJsZW4iLCJzY3JvbGxJbnRvVmlldyIsImN1cnJlbnQiLCJibG9jayIsImJlaGF2aW9yIiwic2Nyb2xsSW50b1ZpZXdFbmQiLCJpblZpZXciLCJjdXJyZW50R3JvdXBNZW51IiwiY3VycmVudEdyb3VwSXRlbSIsInJlY3RHcm91cCIsImdldEJvdW5kaW5nQ2xpZW50UmVjdCIsInJlY3RJdGVtIiwidmlld0hlaWdodCIsIk1hdGgiLCJtaW4iLCJkb2N1bWVudCIsImRvY3VtZW50RWxlbWVudCIsImNsaWVudEhlaWdodCIsIndpbmRvdyIsImlubmVySGVpZ2h0IiwiYWJzIiwidG9wIiwiaXNJblZpZXdwb3J0IiwicmVmIiwib2Zmc2V0IiwiZ2V0U3RhdHVzQmFkZ2VzIiwidmVyc2VGaW5pc2hlZCIsInZlcnNlSXNWYWxpZCIsImdseXBocyIsImNvbnRleHRJZCIsInJlZmVyZW5jZSIsInB1c2giLCJtYWtlU3RhdHVzQmFkZ2VDb21wb25lbnRzIiwic3RhdHVzR2x5cGhzIiwiZ2V0R2x5cGhJY29ucyIsIm1haW5HbHlwaCIsInRvb2x0aXAiLCJSZWFjdERPTVNlcnZlciIsInJlbmRlclRvU3RyaW5nIiwiZ2x5cGhpY29ucyIsImdseXBo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Z0I7QUFBSyxNQUFBLEdBQUcsRUFBQyxPQUFUO0FBQWlCLE1BQUEsU0FBUyxFQUFDO0FBQTNCLE1BQWhCO0FBQ0Q7O0FBQ0QsU0FBT1EsVUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBSZWFjdERPTVNlcnZlciBmcm9tICdyZWFjdC1kb20vc2VydmVyJztcbmltcG9ydCB7IEdseXBoaWNvbiB9IGZyb20gJ3JlYWN0LWJvb3RzdHJhcCc7XG5pbXBvcnQgSW52YWxpZGF0ZWRJY29uIGZyb20gJy4uL0dyb3Vwc01lbnVGaWx0ZXIvSW52YWxpZGF0ZWRJY29uJztcbmV4cG9ydCBjb25zdCBNRU5VX0JBUl9IRUlHSFQgPSAzMDtcbmV4cG9ydCBjb25zdCBNRU5VX0lURU1fSEVJR0hUID0gMzg7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRHcm91cERhdGEoZ3JvdXBzRGF0YSwgZ3JvdXBJZCkge1xuICBsZXQgZ3JvdXBEYXRhO1xuXG4gIGlmIChncm91cHNEYXRhICE9PSB1bmRlZmluZWQpIHtcbiAgICBncm91cERhdGEgPSBncm91cHNEYXRhW2dyb3VwSWRdO1xuICB9XG4gIHJldHVybiBncm91cERhdGE7XG59XG5cbmV4cG9ydCBjb25zdCBnZXRGaWx0ZXJDb3VudCA9IChmaWx0ZXJzKSA9PiBPYmplY3Qua2V5cyhmaWx0ZXJzKS5maWx0ZXIoayA9PiBmaWx0ZXJzW2tdKS5sZW5ndGg7XG5cbi8qKlxuICogQGRlc2NyaXB0aW9uIC0gRGV0ZXJtaW5lcyBpZiB0aGUgaXRlbSBzaG91bGQgYmUgbmF2aWdhdGFibGVcbiAqIEBwYXJhbSB7b2JqZWN0fSBncm91cEl0ZW1EYXRhXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAqL1xuZXhwb3J0IGNvbnN0IGdyb3VwSXRlbUlzVmlzaWJsZSA9IChncm91cEl0ZW1EYXRhLCBmaWx0ZXJzKSA9PiAoIWdldEZpbHRlckNvdW50KGZpbHRlcnMpIHx8XG4gICAgKChmaWx0ZXJzLmludmFsaWRhdGVkICYmIGdyb3VwSXRlbURhdGEuaW52YWxpZGF0ZWQpXG4gICAgICB8fCAoZmlsdGVycy5yZW1pbmRlcnMgJiYgZ3JvdXBJdGVtRGF0YS5yZW1pbmRlcnMpXG4gICAgICB8fCAoZmlsdGVycy5zZWxlY3Rpb25zICYmIGdyb3VwSXRlbURhdGEuc2VsZWN0aW9ucylcbiAgICAgIHx8IChmaWx0ZXJzLm5vU2VsZWN0aW9ucyAmJiAhZ3JvdXBJdGVtRGF0YS5zZWxlY3Rpb25zKVxuICAgICAgfHwgKGZpbHRlcnMudmVyc2VFZGl0cyAmJiBncm91cEl0ZW1EYXRhLnZlcnNlRWRpdHMpXG4gICAgICB8fCAoZmlsdGVycy5jb21tZW50cyAmJiBncm91cEl0ZW1EYXRhLmNvbW1lbnRzKVxuICAgICkpO1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvbiAtIERldGVybWluZXMgaWYgdGhlIGdyb3VwIGlzIG5hdmlnYXRhYmxlIGJhc2VkIG9uIGZpbHRlcnNcbiAqIEBwYXJhbSB7b2JqZWN0fSBncm91cERhdGFcbiAqIEByZXR1cm5zIHtib29sZWFufVxuICovXG5leHBvcnQgY29uc3QgZ3JvdXBJc1Zpc2libGUgPSAoZ3JvdXBEYXRhLCBmaWx0ZXJzKSA9PiB7XG4gIGlmICghZ2V0RmlsdGVyQ291bnQoZmlsdGVycykpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGZvciAobGV0IGkgPSAwLCBsZW4gPSBncm91cERhdGEubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICBjb25zdCBncm91cEl0ZW1EYXRhID0gZ3JvdXBEYXRhW2ldO1xuXG4gICAgaWYgKGdyb3VwSXRlbUlzVmlzaWJsZShncm91cEl0ZW1EYXRhLCBmaWx0ZXJzKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGZhbHNlO1xufTtcblxuLyoqXG4gKiBzY3JvbGxzIGludG8gdmlldywgYnV0IHdpbGwgYmUgdG93YXJkIHRvcFxuICogQHBhcmFtIHtvYmplY3R9IGN1cnJlbnRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNjcm9sbEludG9WaWV3KHsgY3VycmVudCB9KSB7XG4gIGlmIChjdXJyZW50ICYmIGN1cnJlbnQuc2Nyb2xsSW50b1ZpZXcpIHtcbiAgICBjdXJyZW50LnNjcm9sbEludG9WaWV3KHsgYmxvY2s6ICdzdGFydCcsIGJlaGF2aW9yOiAnc21vb3RoJyB9KTtcbiAgfVxufVxuXG4vKipcbiAqIHNjcm9sbHMgaW50byB2aWV3LCBidXQgd2lsbCBiZSB0b3dhcmQgYm90dG9tXG4gKiBAcGFyYW0ge29iamVjdH0gaXRlbVxuICovXG5leHBvcnQgZnVuY3Rpb24gc2Nyb2xsSW50b1ZpZXdFbmQoeyBjdXJyZW50IH0pIHtcbiAgaWYgKGN1cnJlbnQgJiYgY3VycmVudC5zY3JvbGxJbnRvVmlldykge1xuICAgIGN1cnJlbnQuc2Nyb2xsSW50b1ZpZXcoZmFsc2UpOyAvLyBtdXN0IHVzZSBib29sZWFuIHZhbHVlIGhlcmUgYmVjYXVzZSB3ZSBhcmUgdXNpbmcgYW4gb2xkZXIgY2hyb21pdW0gdGhhdCBkb2VzIG5vdCB5ZXQgc3VwcG9ydCBzY3JvbGxJbnRvVmlld09wdGlvbnNcbiAgfVxufVxuXG4vKipcbiAqXG4qIEBkZXNjcmlwdGlvbiAtIFRlc3RzIGlmIHRoZSB0aGUgdHdvIGVsZW1lbnRzIGFyZSBpbiB0aGUgc2NvcGUgb2YgdGhlIHdpbmRvdyAoc2Nyb2xsIGJhcilcbiogVGhlIGNvbnN0cyBNRU5VX0JBUl9IRUlHSFQgJiBNRU5VX0lURU1fSEVJR0hUIGFyZSBzZXQgdG8gYWNjb3VudCBmb3IgdGhlIHN0YXRpYyB3aW5kb3cgYXZpYWxhYmxpdHlcbiogQHBhcmFtIHtvYmplY3R9IGN1cnJlbnRHcm91cE1lbnUgLSBUaGUgY3VycmVudCBncm91cCBtZW51IGhlYWRlciB0aGF0IGlzIGV4dGVuZGVkL2FjdGl2ZWQgKGkuZS4gTWV0YXBob3JzKVxuKiBAcGFyYW0ge29iamVjdH0gY3VycmVudEdyb3VwSXRlbSAtIFRoZSBjdXJyZW50IGdyb3VwIGNoZWNrIGl0ZW0gdGhhdCBpcyBhY3RpdmUgKGkuZS4gTHVrZSAxOjEpXG4qL1xuZXhwb3J0IGZ1bmN0aW9uIGluVmlldyh7IGN1cnJlbnQ6IGN1cnJlbnRHcm91cE1lbnUgfSwgeyBjdXJyZW50OiBjdXJyZW50R3JvdXBJdGVtIH0pIHtcbiAgaWYgKGN1cnJlbnRHcm91cE1lbnUgJiYgY3VycmVudEdyb3VwSXRlbSkge1xuICAgIGNvbnN0IHJlY3RHcm91cCA9IGN1cnJlbnRHcm91cE1lbnUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgY29uc3QgcmVjdEl0ZW0gPSBjdXJyZW50R3JvdXBJdGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIGNvbnN0IHZpZXdIZWlnaHQgPSBNYXRoLm1pbihkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0LCB3aW5kb3cuaW5uZXJIZWlnaHQpO1xuICAgIHJldHVybiBNYXRoLmFicyhyZWN0R3JvdXAudG9wIC0gcmVjdEl0ZW0udG9wKSArIChNRU5VX0JBUl9IRUlHSFQgKyBNRU5VX0lURU1fSEVJR0hUICogMikgPD0gdmlld0hlaWdodDtcbiAgfVxufVxuXG4vKipcbiAqIENoZWNrcyBpZiB0aGUgcmVhY3QgcmVmIGlzIHZlcnRpY2FsbHkgd2l0aGluIHRoZSB2aWV3cG9ydC5cbiAqIEBwYXJhbSByZWYgLSB0aGUgcmVhY3QgcmVmXG4gKiBAcmV0dXJuIHtib29sZWFufVxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNJblZpZXdwb3J0KHJlZikge1xuICBpZiAocmVmICYmIHJlZi5jdXJyZW50KSB7XG4gICAgY29uc3Qgb2Zmc2V0ID0gTUVOVV9CQVJfSEVJR0hUICsgTUVOVV9JVEVNX0hFSUdIVDtcbiAgICBjb25zdCB0b3AgPSByZWYuY3VycmVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3A7XG4gICAgcmV0dXJuICh0b3AgPj0gMCkgJiYgKHRvcCArIG9mZnNldCA8PSB3aW5kb3cuaW5uZXJIZWlnaHQpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIEBkZXNjcmlwdGlvbiAtIGdldHMgdGhlIHN0YXR1cyBiYWRnZSBjb21wb25lbnQgZm9yIHRoZSBncm91cCBtZW51IHJvd1xuICogQHBhcmFtIHtvYmplY3R9IGdyb3VwSXRlbURhdGFcbiAqIEBwYXJhbSB2ZXJzZUZpbmlzaGVkXG4gKiBAcGFyYW0gdmVyc2VJc1ZhbGlkXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRTdGF0dXNCYWRnZXMoZ3JvdXBJdGVtRGF0YSwgdmVyc2VGaW5pc2hlZCwgdmVyc2VJc1ZhbGlkKSB7XG4gIGNvbnN0IGdseXBocyA9IFtdO1xuXG4gIGlmIChncm91cEl0ZW1EYXRhICYmIGdyb3VwSXRlbURhdGEuY29udGV4dElkICYmIGdyb3VwSXRlbURhdGEuY29udGV4dElkLnJlZmVyZW5jZSkge1xuICAgIC8vIFRoZSBiZWxvdyBpZnMgYXJlIGluIG9yZGVyIG9mIHByZWNlZGVuY2Ugb2YgdGhlIHN0YXR1cyBiYWRnZXMgd2Ugc2hvd1xuICAgIGlmIChncm91cEl0ZW1EYXRhLmludmFsaWRhdGVkIHx8ICF2ZXJzZUlzVmFsaWQpIHtcbiAgICAgIGdseXBocy5wdXNoKCdpbnZhbGlkYXRlZCcpO1xuICAgIH1cblxuICAgIGlmIChncm91cEl0ZW1EYXRhLnJlbWluZGVycykge1xuICAgICAgZ2x5cGhzLnB1c2goJ2Jvb2ttYXJrJyk7XG4gICAgfVxuXG4gICAgaWYgKGdyb3VwSXRlbURhdGEuc2VsZWN0aW9ucyB8fCB2ZXJzZUZpbmlzaGVkKSB7XG4gICAgICBnbHlwaHMucHVzaCgnb2snKTtcbiAgICB9XG5cbiAgICBpZiAoZ3JvdXBJdGVtRGF0YS52ZXJzZUVkaXRzKSB7XG4gICAgICBnbHlwaHMucHVzaCgncGVuY2lsJyk7XG4gICAgfVxuXG4gICAgaWYgKGdyb3VwSXRlbURhdGEuY29tbWVudHMpIHtcbiAgICAgIGdseXBocy5wdXNoKCdjb21tZW50Jyk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG1ha2VTdGF0dXNCYWRnZUNvbXBvbmVudHMoZ2x5cGhzKTtcbn1cblxuLyoqXG4gKiBAZGVzY3JpcHRpb24gLSBUYWtlcyBhbiBhcnJheSBvZiBnbHlwaCBuYW1lcywgZ2V0cyB0aGVpciBSZWFjdCBjb21wb25lbnRzIGFuZCB0aGVuIHJlbmRlcnMgdGhlIHN0YXR1cyBiYWRnZVxuICogd2l0aCB0aGUgZmlyc3QgaWNvbiBhbmQgdGhlbiBhIG1vdXNlLW92ZXIgdG9vbHRpcCB3aXRoIHRoZSByZXN0IG9mIHRoZSBpY29ucyBhbmQgYSBjaGlwIHRvIHNheSBob3cgbWFueSBpY29ucyB0aGVyZSBhcmUuXG4gKiBAcGFyYW0geyp9IGdseXBoc1xuICovXG5leHBvcnQgZnVuY3Rpb24gbWFrZVN0YXR1c0JhZGdlQ29tcG9uZW50cyhnbHlwaHMpIHtcbiAgY29uc3Qgc3RhdHVzR2x5cGhzID0gZ2V0R2x5cGhJY29ucyhnbHlwaHMpO1xuICBjb25zdCBtYWluR2x5cGggPSBzdGF0dXNHbHlwaHNbMF07XG5cbiAgaWYgKHN0YXR1c0dseXBocy5sZW5ndGggPiAxKSB7XG4gICAgY29uc3QgdG9vbHRpcCA9IFJlYWN0RE9NU2VydmVyLnJlbmRlclRvU3RyaW5nKHN0YXR1c0dseXBocyk7XG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwic3RhdHVzLWJhZGdlLXdyYXBwZXJcIj5cbiAgICAgICAgPGRpdlxuICAgICAgICAgIGNsYXNzTmFtZT1cInN0YXR1cy1iYWRnZVwiXG4gICAgICAgICAgZGF0YS1mb3I9XCJncm91cHMtdG9vbHRpcFwiXG4gICAgICAgICAgZGF0YS10aXA9e3Rvb2x0aXB9XG4gICAgICAgICAgZGF0YS1odG1sPVwidHJ1ZVwiXG4gICAgICAgICAgZGF0YS1wbGFjZT1cImJvdHRvbVwiXG4gICAgICAgICAgZGF0YS1lZmZlY3Q9XCJmbG9hdFwiXG4gICAgICAgICAgZGF0YS10eXBlPVwibGlnaHRcIlxuICAgICAgICAgIGRhdGEtY2xhc3M9XCJncm91cC1tZW51LXN0YXR1cy10b29sdGlwXCJcbiAgICAgICAgICBkYXRhLWRlbGF5LWhpZGU9XCIxMDBcIj5cbiAgICAgICAgICB7bWFpbkdseXBofVxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiYmFkZ2VcIj5cbiAgICAgICAgICAgIHtzdGF0dXNHbHlwaHMubGVuZ3RofVxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuICAgICk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwic3RhdHVzLWJhZGdlLXdyYXBwZXJcIj5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJzdGF0dXMtYmFkZ2VcIj5cbiAgICAgICAgICB7bWFpbkdseXBofVxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuICAgICk7XG4gIH1cbn1cblxuXG4vKipcbiAqIEBkZXNjcmlwdGlvbiAtIFRha2VzIGFuIGFycmF5IG9mIHN0cmluZ3MgdGhhdCBhcmUgZ2x5cGggbmFtZXMgYW5kIGdldHMgdGhlIHByb3BlciBSZWFjdCBjb21wb25lbnQgdG8gcmVuZGVyIHRoZW1cbiAqIEBwYXJhbSB7YXJyYXl9IGdseXBoc1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0R2x5cGhJY29ucyhnbHlwaHMpIHtcbiAgY29uc3QgZ2x5cGhpY29ucyA9IFtdO1xuXG4gIGlmIChnbHlwaHMgJiYgZ2x5cGhzLmxlbmd0aCkge1xuICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBnbHlwaHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgIGNvbnN0IGdseXBoID0gZ2x5cGhzW2ldO1xuXG4gICAgICBpZiAoZ2x5cGggPT09ICdpbnZhbGlkYXRlZCcpIHtcbiAgICAgICAgZ2x5cGhpY29ucy5wdXNoKDxkaXYga2V5PXtnbHlwaH0gY2xhc3NOYW1lPXsnZ2x5cGhpY29uIGdseXBoaWNvbi1pbnZhbGlkYXRlZCd9PjxJbnZhbGlkYXRlZEljb24gaGVpZ2h0PXsxNn0gd2lkdGg9ezE2fSAvPjwvZGl2Pik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsZXQgY2xhc3NOYW1lID0gJ3N0YXR1cy1pY29uLScgKyBnbHlwaDtcbiAgICAgICAgZ2x5cGhpY29ucy5wdXNoKDxHbHlwaGljb24ga2V5PXtnbHlwaH0gZ2x5cGg9e2dseXBofSBjbGFzc05hbWU9e2NsYXNzTmFtZX0gLz4pO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBnbHlwaGljb25zLnB1c2goPGRpdiBrZXk9XCJibGFua1wiIGNsYXNzTmFtZT1cImdseXBoaWNvbiBnbHlwaGljb24tYmxhbmsgc3RhdHVzLWljb24tYmxhbmtcIiAvPik7XG4gIH1cbiAgcmV0dXJuIGdseXBoaWNvbnM7XG59XG4iXX0=